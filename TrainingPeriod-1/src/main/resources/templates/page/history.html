<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手順書編集記録</title>
    <link href="/css/history.css" rel="stylesheet">
    <link href="/css/diff.css" rel="stylesheet">

</head>
<body>
    <div class="container">
        <!-- 左側 -->
        <div class="history-card">
            <h2 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                バージョン履歴
            </h2>
            <div class="history-list" id="historyList">
            </div>
        </div>

        <!-- 右側のコンテンツ表示 -->
        <div class="content-card">
            <h2 class="card-title">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ファイルコンテンツ
            </h2>
            <div class="content-viewer">
                <div class="version-control">
                    <div class="select-group">
                        <select id="oldVersion" class="version-select">
                            <option value="">旧バージョンを選択</option>
                        </select>
                        <select id="newVersion" class="version-select">
                            <option value="">新バージョンを選択</option>
                        </select>
                        <button id="compareButton" class="compare-button">比較</button>
                    </div>
                </div>
                <div id="normalView">
                    <div class="content-header" id="contentHeader">
                        バージョンを選択してください
                    </div>
                    <div class="content-body" id="contentBody"></div>
                </div>
                <div id="diffView" style="display:none;">
                    <div class="diff-header">バージョン比較</div>
                    <div class="diff-content" id="diffContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">

        // 初期データの設定
        const initialHistory = /*[[${history}]]*/ [];
        const currentFileId = /*[[${fileId}]]*/ '';

        // DOMコンテンツ読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', () => {
            // 履歴データが存在する場合は最新バージョンを表示
            if (initialHistory && initialHistory.length > 0) {
                showContent(initialHistory[0]);
            } else {
                // ファイルIDを取得して履歴一覧を初期化
                const fileId = currentFileId || window.location.pathname.split('/').pop();
                initializeHistoryList(fileId);
            }

            // 履歴アイテムのクリックイベントを設定
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    // アクティブ状態の更新
                    document.querySelectorAll('.history-item').forEach(i =>
                        i.classList.remove('active'));
                    item.classList.add('active');

                    // バージョン情報の取得と表示
                    const version = item.getAttribute('data-version');
                    const content = item.getAttribute('data-content');
                    showContent({
                        version: version,
                        content: content,
                        editor: item.querySelector('.author-info span').textContent.replace('編集者：', ''),
                        createTime: item.querySelector('.create-time').textContent,
                        commitMessage: item.querySelector('.commit-message').textContent
                    });
                });
            });
        });

        // 履歴データをサーバーから取得
        async function fetchHistoryData(fileId) {
            try {
                const response = await fetch(`/list/${fileId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`記録取得失敗: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('記録取得失敗：', error);
                throw error;
            }
        }

        // 選択されたバージョンの内容を表示
        function showContent(history) {
            const contentHeader = document.getElementById('contentHeader');
            const contentBody = document.getElementById('contentBody');

            // ヘッダー情報の設定
            contentHeader.innerHTML = `
                <h3>Version ${history.version}</h3>
                <div class="author-info">
                    <span>編集者：${history.editor}</span>
                    <span>提出時間：${history.createTime}</span>
                </div>
                <div class="commit-message">${history.commitMessage}</div>
            `;

            // 内容の表示
            contentBody.textContent = history.content;

            // 表示モードの切り替え
            document.getElementById('normalView').style.display = 'block';
            document.getElementById('diffView').style.display = 'none';
        }


        document.addEventListener('DOMContentLoaded', () => {
            // 从URL路径中获取fileId
            const pathParts = window.location.pathname.split('/');
            const fileId = pathParts[pathParts.length - 1];
            initializeHistoryList(fileId);
        });

        let versionsData = []; // 全バージョンデータの保存用配列

        // 履歴一覧の初期化
        async function initializeHistoryList(fileId) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            try {
                const historyData = await fetchHistoryData(fileId);
                versionsData = historyData; // 保存数据用于比较

                // 履歴データの取得
                updateVersionSelects(historyData);

                // バージョン選択ドロップダウンの更新
                historyData.forEach(history => {
                    const historyItem = document.createElement('div');
                    const formattedTime = `${history.createTime}`.replace('T', '\n');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                <div class="version-info">
                    <span class="version-number">Version ${history.version}</span><br>
                    <span class="create-time">${formattedTime}</span>
                </div>
                <div class="commit-message">${history.commitMessage}</div>
                <div class="author-info">
                    <span>編集者：${history.editor}</span>
                </div>
            `;

                    // クリックイベントの設定
                    historyItem.addEventListener('click', () => {
                        document.querySelectorAll('.history-item').forEach(item => {
                            item.classList.remove('active');
                        });

                        historyItem.classList.add('active');

                        showContent(history);
                    });

                    historyList.appendChild(historyItem);
                });

                // 最新バージョンの表示
                if (historyData.length > 0) {
                    showContent(historyData[0]);
                    historyList.firstChild.classList.add('active');
                }
            } catch (error) {
                console.error('記録ローディング失敗:', error);
                historyList.innerHTML = '<div class="error-message">記録ローディング失敗</div>';
            }
        }

        // バージョン選択ドロップダウンの更新
        function updateVersionSelects(historyData) {
            const oldSelect = document.getElementById('oldVersion');
            const newSelect = document.getElementById('newVersion');

            // ドロップダウンの初期化
            oldSelect.innerHTML = '<option value="">旧バージョンを選択</option>';
            newSelect.innerHTML = '<option value="">新バージョンを選択</option>';

            // オプションの追加
            historyData.forEach((item, index) => {
                const option = `<option value="${index}">Version ${item.version} (${formatDate(item.createTime)})</option>`;
                oldSelect.insertAdjacentHTML('beforeend', option);
                newSelect.insertAdjacentHTML('beforeend', option);
            });
        }

        // 日付のフォーマット
        function formatDate(dateString) {
            if (!dateString) return '日付不明';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // バージョン間の差分を表示
        async function showDiff(oldContent, newContent) {
            try {
                // 差分データの取得
                const response = await fetch('/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        oldVersion: oldContent,
                        newVersion: newContent
                    })
                });

                if (!response.ok) {
                    throw new Error('比較に失敗しました');
                }

                const diffLines = await response.json();
                const diffContent = document.getElementById('diffContent');

                // 差分の統計情報を計算
                const stats = {
                    additions: diffLines.filter(line => line.startsWith('+')).length,
                    deletions: diffLines.filter(line => line.startsWith('-')).length
                };

                // 差分表示のHTML生成
                // [...HTMLの生成コード...]
                let html = `
            <div class="diff-header">
                <div class="file-info">
                    <span class="file-name">File Changes</span>
                    <div class="file-stats">
                        <span class="additions">+${stats.additions}</span>
                        <span class="deletions">-${stats.deletions}</span>
                    </div>
                </div>
                <div class="diff-stats">
                    <div class="diff-stat-box">
                        ${generateStatBars(stats.additions, stats.deletions)}
                    </div>
                </div>
            </div>
            <div class="diff-content">`;

                let oldLineNum = 1;
                let newLineNum = 1;


                diffLines.forEach(line => {
                    const content = escapeHtml(line.slice(1));
                    const prefix = line[0];

                    if (prefix === '+') {
                        html += `
                    <div class="diff-line diff-addition">
                        <div class="line-number old"></div>
                        <div class="line-number new">${newLineNum++}</div>
                        <div class="line-content"><span class="diff-mark">+</span>${content}</div>
                    </div>`;
                    } else if (prefix === '-') {
                        html += `
                    <div class="diff-line diff-deletion">
                        <div class="line-number old">${oldLineNum++}</div>
                        <div class="line-number new"></div>
                        <div class="line-content"><span class="diff-mark">-</span>${content}</div>
                    </div>`;
                    } else {
                        html += `
                    <div class="diff-line">
                        <div class="line-number old">${oldLineNum++}</div>
                        <div class="line-number new">${newLineNum++}</div>
                        <div class="line-content"><span class="diff-mark"> </span>${content}</div>
                    </div>`;
                    }
                });

                html += '</div>';
                diffContent.innerHTML = html;

                // 切换到差异视图
                document.getElementById('normalView').style.display = 'none';
                document.getElementById('diffView').style.display = 'block';
            } catch (error) {
                console.error('差分表示エラー:', error);
                alert('バージョン比較に失敗しました');
            }
        }

        // HTMLエスケープ処理
        function escapeHtml(str) {
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 統計バーの生成
        function generateStatBars(additions, deletions) {
            const total = additions + deletions;
            const additionWidth = total ? Math.max((additions / total) * 100, 0) : 0;
            const deletionWidth = total ? Math.max((deletions / total) * 100, 0) : 0;

            return `
        <div class="stat-bar">
            <div class="stat-addition" style="width: ${additionWidth}%"></div>
            <div class="stat-deletion" style="width: ${deletionWidth}%"></div>
        </div>
    `;
        }

        // 比較ボタンのイベントリスナー設定
        document.getElementById('compareButton').addEventListener('click', () => {
            const oldIndex = document.getElementById('oldVersion').value;
            const newIndex = document.getElementById('newVersion').value;

            if (!oldIndex || !newIndex) {
                alert('比較するバージョンを選択してください');
                return;
            }

            const oldContent = versionsData[oldIndex].content;
            const newContent = versionsData[newIndex].content;
            showDiff(oldContent, newContent);
        });
    </script>
</body>
</html>